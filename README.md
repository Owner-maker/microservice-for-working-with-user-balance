# microservice-for-working-with-user-balance

## Задача

Необходимо реализовать микросервис для работы с балансом пользователей (зачисление средств, списание средств, перевод средств от пользователя к пользователю, а также метод получения баланса пользователя). Сервис должен предоставлять HTTP API и принимать/отдавать запросы/ответы в формате JSON.

## Инструкция по запуску

1. Клонировать репозиторий локально в любую деректорию своего устройства ``` git clone https://github.com/Owner-maker/microservice-for-working-with-user-balance.git```
2. Перейти в директорию проекта вручную или с помощью консоли ```cd microservice-for-working-with-user-balance```
3. Создать и запустить Docker - контейнер ```docker-compose build && docker-compose up```
4. После запуска контейнера все сущности автоматически будут созданы в базе данных
5. Также будут автоматически добавлены 2 тестовых пользователя с отсутствующими балансами ```Их id = 1 и id = 2 соответственно```

### Какие технологии использовались:
- Golang
- Gin
- Gorm
- PostgreSQL
- Swagger
- Docker

### Какие методы реализованы:

- [Получение баланса пользователя](#баланс)
- Пополнение баланса пользователя
- Перевод средств другому пользователю
- Покупка услуги пользователем (резервирование средств)
- Признание выручки - подтверждение выполнения услуги
- Разрезервирование средств - отмена услуги
- Создание csv файла (отчета) с данными о суммарной выручке за все услуги за определенный месяц и год
- Получение данных с отчета о суммарной выручке всех услуг
- Получение транзакций пользователя с пагинацией и сортировкой по атрибутам транзакции

### Структура базы данных

![image](database_schema.png)

## Примеры запросов:

Для удобства использования API была использован Swagger, но примеры ниже будут представлены в текстовом виде


### <a name="баланс">Получение баланса пользователя</a> - метод PATCH
- Принимает id пользователя и сумму для зачисления
- В случае отсутствия кошелька - будет создан автоматически
```
{
    "id" : 2,
    "value" : 400
}
```

- В ответ получаем итоговый баланс пользователя
```
{
    "balance": 800
}
```


## Вопросы / примечания по ТЗ
1. Резервирование средств: должно ли присутствовать отдельное поле как "резервный" счет пользователя?
  - Я реализовал это следующим образом - как таковое резервирование средств, насколько я понимаю, это списание денежных средств с "основного" счета пользователя (поле "balance" сущности "user") и начисление их на "резервный" (отдельный) счет пользователя, поэтому при покупке услуги, с поля "value" сущности "balance" списываются средства в размере стоимости услуги и создается новая "транзакция" (а именно сущность "Order"), которая уже хранит в себе информацию о т.н. зарезервированных средствах. Такая транзакция обладает статусом "is_completed" (по умолчанию false), а после того, как услуга будет выполнена "транзакция" получает статус true и заполняется поле "timestamp" (время выполнения услуги), если услуга была отменена/не выполнена, "зарезервированные" средства возвращаются на "основной" счет пользователя (поле "balance"), а поля "incoming_balance", "outgoing_balance", "timestamp" заполняются повторно.
2. Поля "id услуги" и "id заказа" в теле запроса на резервирование средств, необходимо ли оно?
  - На мой взгляд тут два сценария: либо данный микросервис ничего не знает о том, за какие именно услуги у пользователя списываются средства с баланса и тогда ему необходимо принимать поле "id услуги" и ее стоимость, а сервис является лишь неким акселератором данных о средствах пользователя, либо же сервис (также здесь подразумеваю и наличие соотвествующих сущностей в БД) уже обладает некой информацией заранее о том, за что именно у пользователя будут списываться средства (есть список услуг). При втором подходе сервис должен контролировать наличие услуг и отвечать за их валидацию, на мой взгляд, это уже не отвечает требованиям того, чем должен заниматься сервис, его задача - принять и обработать информацию о том, какая денежная транзакция произошла и за что списать / начислить деньги, соотвественно я выбрал первый вариант, при котором сущность "order" помимо всего прочего будет хранить в себе поле "id услуги", но не в роли внешнего ключа, а как информацию от другого сервиса, к примеру о том, что была оказана именно такая услуга под таким идентификатором, что в конечном итоге может уже использовать другой сервис, который, к примеру, отвечает исключительно за услуги и т.п.
  - В поле "id заказа" на мой взгляд при резервировании средств нет смысла, так как данная сущность будет только создана при вызове соотсветствующего метода (API), но оно уже будет необходимо при признании выручки или разрезервировании средств.
  - В случае признания выручки на мой взгляд поле "price" будет излишним, т.к. информация об уже зарезервированных средствах есть в БД.
